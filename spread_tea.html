<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>茶叶传播之路：从中国到世界</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            overflow: hidden;
            background-color: #f2f0e9;
        }

        /* 仿古地图滤镜 */
        .leaflet-layer {
            filter: sepia(0.4) contrast(0.9) brightness(1.02) saturate(0.6);
        }

        /* 诗词专用字体 */
        .font-poem {
            font-family: 'Ma Shan Zheng', cursive;
            line-height: 1.8;
        }

        /* 标记点样式 */
        .tea-marker {
            width: 16px;
            height: 16px;
            background: #059669;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.3);
            transition: transform 0.1s;
        }

        .tea-marker-active {
            transform: scale(1.2);
            box-shadow: 0 0 0 6px rgba(5, 150, 105, 0.4);
        }

        /* 玻璃拟态卡片 */
        .glass-card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        /* 播放按钮动效 */
        .play-btn-active {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(5, 150, 105, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(5, 150, 105, 0);
            }
        }

        /* 隐藏 Leaflet 默认控件以保持古风 */
        .leaflet-control-container .leaflet-top {
            top: 80px;
        }

        /* 时间轴滑块美化 */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #059669;
            border: 2px solid #fff;
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #d1d5db;
            border-radius: 2px;
        }
    </style>
</head>

<body class="text-stone-800">
    <!-- 地图容器 -->
    <div id="map" class="absolute inset-0 z-0"></div>

    <!-- 顶部控制栏 -->
    <div class="absolute top-0 left-0 w-full z-50 p-4 pointer-events-none">
        <div class="max-w-3xl mx-auto glass-card rounded-xl p-4 pointer-events-auto flex flex-col gap-3">
            <!-- 标题与年份 -->
            <div class="flex justify-between items-baseline border-b border-stone-200 pb-2">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl md:text-2xl font-bold text-stone-900 tracking-wide">茶叶传播之路</h1>
                    <span id="status-badge" class="px-2 py-0.5 rounded text-xs font-medium bg-stone-100 text-stone-600 border border-stone-200">
                        起源中国
                    </span>
                </div>
                <div class="text-right">
                    <span class="text-sm text-stone-500 mr-1">公元</span>
                    <span id="display-year" class="text-3xl font-bold text-emerald-900 font-mono">前2737</span>
                    <span class="text-sm text-stone-500 ml-1">年</span>
                </div>
            </div>

            <!-- 播放控制与时间轴 -->
            <div class="flex items-center gap-4">
                <button id="play-btn" class="flex-shrink-0 w-10 h-10 rounded-full bg-stone-800 text-white flex items-center justify-center hover:bg-stone-700 transition focus:outline-none" onclick="togglePlay()">
                    <svg id="icon-play" class="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                    <svg id="icon-pause" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                    </svg>
                </button>

                <div class="flex-grow relative h-8 flex items-center group">
                    <!-- 年份刻度 -->
                    <div class="absolute top-1/2 -translate-y-1/2 w-full h-1 bg-stone-300 rounded pointer-events-none"></div>
                    <!-- 关键年份点 -->
                    <div class="absolute w-full h-full pointer-events-none flex justify-between text-[10px] text-stone-400 font-mono pt-5">
                        <span>前2737</span>
                        <span style="left: 20%; position: absolute">618</span>
                        <span style="left: 40%; position: absolute">1405</span>
                        <span style="left: 60%; position: absolute">1607</span>
                        <span style="left: 80%; position: absolute">1848</span>
                        <span>1900</span>
                    </div>
                    <input type="range" id="timeline" min="-2737" max="1900" step="1" value="-2737" class="relative z-10 w-full" oninput="manualScrub()">
                </div>

                <div class="flex-shrink-0 text-center min-w-[60px]">
                    <div class="text-xs text-stone-400 uppercase">传播</div>
                    <div class="font-mono text-sm font-bold text-stone-700"><span id="distance-display">0</span> km</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧：茶叶历史与地点浮窗 -->
    <div id="info-panel" class="absolute top-32 right-4 w-[90%] md:w-[360px] z-40 pointer-events-none transition-all duration-700 opacity-0 translate-x-8">
        <div class="glass-card rounded-lg overflow-hidden pointer-events-auto shadow-2xl">
            <!-- 题头 -->
            <div class="bg-stone-50/80 p-4 border-b border-stone-100 flex items-center justify-between">
                <div>
                    <div id="card-location" class="text-lg font-bold text-emerald-900">地点</div>
                    <div id="card-role" class="text-xs text-stone-500">茶史事件</div>
                </div>
                <div class="w-8 h-8 rounded-full bg-emerald-50 border border-emerald-100 flex items-center justify-center text-emerald-800 text-sm font-serif font-bold">
                    茶
                </div>
            </div>

            <!-- 内容 -->
            <div class="p-5 max-h-[50vh] overflow-y-auto">
                <div id="poem-container" class="text-center mb-4">
                    <h3 id="card-title" class="text-md font-bold text-stone-800 mb-2"></h3>
                    <div id="card-poem" class="font-poem text-lg text-stone-700 whitespace-pre-wrap"></div>
                </div>
                <div class="border-t border-stone-100 pt-3 mt-2">
                    <p id="card-desc" class="text-sm text-stone-600 leading-relaxed text-justify indent-4"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部图例 -->
    <div class="absolute bottom-4 left-0 w-full text-center pointer-events-none z-30">
        <div class="inline-flex items-center gap-4 text-xs text-stone-400 bg-white/50 px-3 py-1 rounded-full backdrop-blur-sm">
            <div class="flex items-center gap-1">
                <div class="w-3 h-1 bg-amber-800 rounded"></div>
                <span>陆上丝绸之路</span>
            </div>
            <div class="flex items-center gap-1">
                <div class="w-3 h-1 bg-blue-600 rounded"></div>
                <span>海上丝绸之路</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==========================================
        // 1. 核心数据结构：茶叶传播节点与路径
        // ==========================================
        const teaJourney = [
            {
                name: "中国云南",
                role: "起源 · 发现",
                startYear: -2737,
                endYear: -2000,
                coords: [25.04, 102.72],
                poem: { 
                    title: "神农尝百草", 
                    content: "神农尝百草，日遇七十二毒，\n得茶而解之。" 
                },
                desc: "传说中，神农氏在公元前2737年发现了茶叶的解毒功效，这是茶叶历史的开端。云南被认为是茶树的原产地之一。",
                path: [],
                type: "origin"
            },
            {
                name: "四川盆地",
                role: "早期栽培",
                startYear: -1000,
                endYear: -200,
                coords: [30.65, 104.07],
                poem: { 
                    title: "周原膴膴", 
                    content: "周原膴膴，堇荼如饴。\n爰始爰谋，爰契我龟。" 
                },
                desc: "在周朝时期，巴蜀地区已经开始人工栽培茶树，并将茶叶作为贡品献给周王室。",
                path: [[25.04, 102.72], [28.76, 104.64], [30.65, 104.07]],
                type: "land"
            },
            {
                name: "长安",
                role: "茶文化形成",
                startYear: 618,
                endYear: 750,
                coords: [34.26, 108.94],
                poem: { 
                    title: "茶经", 
                    content: "茶之为饮，发乎神农氏，\n闻于鲁周公。" 
                },
                desc: "唐朝时期，陆羽著《茶经》，系统总结了茶叶生产、制作和饮用的知识，标志着中国茶文化的正式形成。茶叶通过丝绸之路开始向西方传播。",
                path: [[30.65, 104.07], [32.06, 108.80], [34.26, 108.94]],
                type: "land"
            },
            {
                name: "敦煌",
                role: "陆路西传",
                startYear: 750,
                endYear: 850,
                coords: [40.14, 94.66],
                poem: { 
                    title: "敦煌遗书", 
                    content: "茶香飘万里，\n丝路连东西。" 
                },
                desc: "敦煌作为丝绸之路的重要节点，见证了茶叶通过陆路向中亚、西亚传播的历史。茶叶与丝绸、瓷器一起成为丝路贸易的重要商品。",
                path: [[34.26, 108.94], [36.06, 103.82], [37.50, 105.20], [39.47, 98.41], [40.14, 94.66]],
                type: "land"
            },
            {
                name: "巴格达",
                role: "传入阿拉伯",
                startYear: 850,
                endYear: 1000,
                coords: [33.31, 44.36],
                poem: { 
                    title: "天方夜谭", 
                    content: "东方神秘叶，\n香飘天方国。" 
                },
                desc: "阿拉伯商人通过丝绸之路将茶叶带回中东，茶叶开始在阿拉伯世界流行。阿拉伯文献中开始出现关于茶叶的记载。",
                path: [[40.14, 94.66], [38.47, 77.04], [36.20, 69.11], [35.70, 51.42], [33.31, 44.36]],
                type: "land"
            },
            {
                name: "日本京都",
                role: "东传日本",
                startYear: 805,
                endYear: 1200,
                coords: [35.01, 135.77],
                poem: { 
                    title: "茶禅一味", 
                    content: "一花开五叶，\n结果自然成。" 
                },
                desc: "日本僧人最澄在中国学习佛法后，将茶籽带回日本，种植在京都比叡山。随后，荣西禅师著《吃茶养生记》，将茶道与禅宗结合，形成了日本独特的茶道文化。",
                path: [[34.26, 108.94], [31.23, 121.47], [32.75, 129.87], [34.39, 132.46], [35.01, 135.77]],
                type: "sea"
            },
            {
                name: "泉州港",
                role: "海路贸易",
                startYear: 1000,
                endYear: 1300,
                coords: [24.91, 118.59],
                poem: { 
                    title: "海丝起点", 
                    content: "涨海声中万国商，\n茶香飘过七洲洋。" 
                },
                desc: "宋元时期，泉州成为东方第一大港，茶叶通过海上丝绸之路大量出口到东南亚、南亚和东非。",
                path: [[30.65, 104.07], [28.76, 115.85], [26.08, 119.30], [24.91, 118.59]],
                type: "sea"
            },
            {
                name: "马六甲",
                role: "南洋枢纽",
                startYear: 1300,
                endYear: 1400,
                coords: [2.19, 102.25],
                poem: { 
                    title: "香料与茶", 
                    content: "千帆竞渡马六甲，\n茶香融汇万国风。" 
                },
                desc: "马六甲海峡成为东西方贸易的重要通道，中国茶叶在此与东南亚香料交换，再转运至印度和阿拉伯世界。",
                path: [[24.91, 118.59], [21.45, 108.20], [13.75, 100.50], [5.41, 100.33], [2.19, 102.25]],
                type: "sea"
            },
            {
                name: "里斯本",
                role: "传入欧洲",
                startYear: 1500,
                endYear: 1550,
                coords: [38.72, -9.14],
                poem: { 
                    title: "大航海时代", 
                    content: "葡国探险越重洋，\n东方奇叶入欧陆。" 
                },
                desc: "葡萄牙航海家开辟了通往东方的新航路，将茶叶直接运回欧洲。茶叶最初作为珍稀药物在葡萄牙王室和贵族中流行。",
                path: [[2.19, 102.25], [6.12, 80.10], [12.97, 77.59], [25.28, 55.33], [38.72, -9.14]],
                type: "sea"
            },
            {
                name: "阿姆斯特丹",
                role: "欧洲普及",
                startYear: 1610,
                endYear: 1650,
                coords: [52.37, 4.90],
                poem: { 
                    title: "荷兰东印度公司", 
                    content: "商船万里运茶忙，\n荷人首开欧陆市。" 
                },
                desc: "荷兰东印度公司开始大规模进口中国茶叶，使茶叶从奢侈品逐渐变为欧洲中产阶级的日常饮品。荷兰人还将茶引入北美殖民地。",
                path: [[38.72, -9.14], [51.15, 2.72], [52.37, 4.90]],
                type: "sea"
            },
            {
                name: "伦敦",
                role: "英式茶文化",
                startYear: 1660,
                endYear: 1700,
                coords: [51.51, -0.13],
                poem: { 
                    title: "下午茶时光", 
                    content: "午后斜阳茶香暖，\n英伦风尚自此传。" 
                },
                desc: "葡萄牙公主凯瑟琳嫁给英王查理二世，将饮茶习惯带入英国宫廷。随后，茶叶在英国各阶层迅速普及，形成了独特的英式下午茶文化。",
                path: [[52.37, 4.90], [51.51, -0.13]],
                type: "sea"
            },
            {
                name: "波士顿",
                role: "美洲传播",
                startYear: 1700,
                endYear: 1773,
                coords: [42.36, -71.06],
                poem: { 
                    title: "波士顿倾茶事件", 
                    content: "自由之价茶箱沉，\n独立钟声由此鸣。" 
                },
                desc: "茶叶随欧洲殖民者传入美洲。1773年，波士顿倾茶事件成为美国独立战争的导火索之一，茶叶在美洲历史中扮演了重要角色。",
                path: [[51.51, -0.13], [42.36, -71.06]],
                type: "sea"
            },
            {
                name: "印度大吉岭",
                role: "殖民地种植",
                startYear: 1840,
                endYear: 1860,
                coords: [27.04, 88.26],
                poem: { 
                    title: "红茶新篇", 
                    content: "喜马拉雅云雾间，\n大吉岭茶誉满球。" 
                },
                desc: "英国东印度公司为了打破中国对茶叶的垄断，在印度殖民地大规模种植茶树。大吉岭红茶因其独特风味很快享誉世界。",
                path: [[24.91, 118.59], [19.08, 72.88], [22.57, 88.36], [27.04, 88.26]],
                type: "sea"
            },
            {
                name: "斯里兰卡",
                role: "锡兰红茶",
                startYear: 1867,
                endYear: 1900,
                coords: [6.93, 79.85],
                poem: { 
                    title: "锡兰红茶", 
                    content: "碧绿茶园遍山岗，\n锡兰红茶世界香。" 
                },
                desc: "咖啡树病害摧毁了斯里兰卡的咖啡种植业，茶农转而种植茶树。锡兰红茶以其浓郁香气和鲜明汤色迅速成为世界三大红茶之一。",
                path: [[27.04, 88.26], [6.93, 79.85]],
                type: "sea"
            }
        ];

        // ==========================================
        // 2. 初始化地图与图层
        // ==========================================
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            zoomSnap: 0.1
        }).setView([30.0, 100.0], 3);

        // 使用 CartoDB Light 并加滤镜
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            minZoom: 2,
            maxZoom: 10
        }).addTo(map);

        // 图层组
        const historyPathGroup = L.layerGroup().addTo(map); // 已完成的路径
        const activePathGroup = L.layerGroup().addTo(map);  // 正在走的路径
        const markerGroup = L.layerGroup().addTo(map);      // 标记点

        // ==========================================
        // 3. 几何算法：路径插值与距离计算
        // ==========================================

        // 计算两点距离 (km)
        function getDist(p1, p2) {
            const R = 6371;
            const dLat = (p2[0] - p1[0]) * Math.PI / 180;
            const dLon = (p2[1] - p1[1]) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(p1[0] * Math.PI / 180) * Math.cos(p2[0] * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // 计算折线总长度
        function getPolylineLength(latlngs) {
            let d = 0;
            for (let i = 0; i < latlngs.length - 1; i++) {
                d += getDist(latlngs[i], latlngs[i + 1]);
            }
            return d;
        }

        // 获取路径上某百分比处的坐标和之前的路径片段
        function getPathAtPercentage(latlngs, percent) {
            if (percent <= 0) return { point: latlngs[0], path: [latlngs[0]], dist: 0 };
            if (percent >= 1) return { point: latlngs[latlngs.length - 1], path: latlngs, dist: getPolylineLength(latlngs) };

            const totalDist = getPolylineLength(latlngs);
            const targetDist = totalDist * percent;

            let currentDist = 0;
            let resultPath = [latlngs[0]];

            for (let i = 0; i < latlngs.length - 1; i++) {
                const segmentDist = getDist(latlngs[i], latlngs[i + 1]);
                if (currentDist + segmentDist >= targetDist) {
                    // 目标点在这段线段上
                    const remaining = targetDist - currentDist;
                    const ratio = remaining / segmentDist;
                    const lat = latlngs[i][0] + (latlngs[i + 1][0] - latlngs[i][0]) * ratio;
                    const lng = latlngs[i][1] + (latlngs[i + 1][1] - latlngs[i][1]) * ratio;
                    const point = [lat, lng];
                    resultPath.push(point);
                    return { point, path: resultPath, dist: targetDist };
                }
                currentDist += segmentDist;
                resultPath.push(latlngs[i + 1]);
            }
            return { point: latlngs[latlngs.length - 1], path: latlngs, dist: totalDist };
        }

        // ==========================================
        // 4. 状态引擎：根据年份计算一切
        // ==========================================

        let currentState = {
            markerPos: null,
            totalDistance: 0,
            activeTeaEvent: null
        };

        function renderByYear(year) {
            historyPathGroup.clearLayers();
            activePathGroup.clearLayers();
            markerGroup.clearLayers();

            let accumulatedDist = 0;
            let activeLocation = null;
            let currentPos = null;
            let isTraveling = false;
            let nextDestination = null;

            // 1. 遍历所有传播节点
            for (let i = 0; i < teaJourney.length; i++) {
                const leg = teaJourney[i];
                const nextLeg = teaJourney[i + 1];

                // 计算这一段(来到这里的路)的长度
                const legPathLen = leg.path.length > 0 ? getPolylineLength(leg.path) : 0;

                // A. 如果这个节点已经完全属于过去
                if (year >= leg.startYear) {
                    // 这是一个已经到达或经过的点
                    // 1. 绘制"来到这里"的完整路径 (如果是起点则无路径)
                    if (leg.path.length > 0) {
                        const pathColor = leg.type === "sea" ? '#2563eb' : '#92400e';
                        L.polyline(leg.path, {
                            color: pathColor,
                            weight: 3,
                            opacity: 0.6,
                            lineCap: 'round'
                        }).addTo(historyPathGroup);
                        accumulatedDist += legPathLen;
                    }

                    // 2. 绘制城市点
                    L.circleMarker(leg.coords, {
                        radius: 3,
                        color: leg.type === "sea" ? '#2563eb' : '#92400e',
                        fillColor: '#fff',
                        fillOpacity: 1
                    }).addTo(historyPathGroup);

                    // 设定当前大致位置
                    currentPos = leg.coords;
                    activeLocation = leg;
                }

                // B. 特殊处理：当前正处在"前往下一站"的途中
                if (nextLeg && year > leg.endYear && year < nextLeg.startYear) {
                    isTraveling = true;
                    nextDestination = nextLeg.name;
                    // 计算进度
                    const totalDuration = nextLeg.startYear - leg.endYear;
                    const elapsed = year - leg.endYear;
                    const progress = elapsed / totalDuration; // 0 ~ 1

                    // 提取 nextLeg.path 的部分路径
                    const partial = getPathAtPercentage(nextLeg.path, progress);

                    // 绘制动态延伸的线
                    const pathColor = nextLeg.type === "sea" ? '#2563eb' : '#92400e';
                    L.polyline(partial.path, {
                        color: pathColor,
                        weight: 4,
                        opacity: 1,
                        dashArray: '1, 6', // 虚线效果
                        lineCap: 'round'
                    }).addTo(activePathGroup);

                    currentPos = partial.point;
                    accumulatedDist += partial.dist;
                    activeLocation = null; // 在路上，没有定居点

                    // 既然正在去 i+1，循环可以停止了，因为后面的还没发生
                    break;
                }

                // C. 如果当前时间还在这个点的传播期内
                if (year >= leg.startYear && year <= leg.endYear) {
                    isTraveling = false;
                    currentPos = leg.coords;
                    activeLocation = leg;
                    break;
                }

                // D. 如果当前年份还没到这个点的开始时间
                if (year < leg.startYear) {
                    if (i === 0) {
                        currentPos = leg.coords;
                        activeLocation = leg; // 暂且停在起点
                    }
                    break;
                }
            }

            // 更新 UI
            updateUI(year, currentPos, accumulatedDist, activeLocation, isTraveling, nextDestination);
        }

        function updateUI(year, pos, dist, location, isTraveling, nextDest) {
            // 1. Marker
            if (pos) {
                const iconHtml = `<div class="tea-marker ${isTraveling ? 'tea-marker-active' : ''}"></div>`;
                const icon = L.divIcon({
                    className: 'bg-transparent',
                    html: iconHtml,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                L.marker(pos, { icon: icon, zIndexOffset: 1000 }).addTo(markerGroup);

                // 相机跟随逻辑
                const currentCenter = map.getCenter();
                const d = getDist([currentCenter.lat, currentCenter.lng], pos);
                if (d > 800 || isTraveling) {
                    map.panTo(pos, { animate: true, duration: 0.8, easeLinearity: 0.5 });
                }
            }

            // 2. Text Info - 年份显示为整数
            const displayYear = year < 0 ? `前${Math.abs(Math.floor(year))}` : Math.floor(year);
            document.getElementById('display-year').innerText = displayYear;
            
            // 确保时间轴滑块位置与当前年份一致
            document.getElementById('timeline').value = Math.floor(year);
            
            document.getElementById('distance-display').innerText = Math.floor(dist);

            const statusBadge = document.getElementById('status-badge');
            const infoPanel = document.getElementById('info-panel');

            if (isTraveling) {
                statusBadge.innerText = `传播至 ${nextDest}...`;
                statusBadge.className = "px-2 py-0.5 rounded text-xs font-medium bg-emerald-50 text-emerald-600 border border-emerald-100 animate-pulse";

                // 传播途中不显示详细卡片
                infoPanel.classList.add('opacity-0', 'translate-x-8');
            } else if (location) {
                statusBadge.innerText = location.role;
                statusBadge.className = "px-2 py-0.5 rounded text-xs font-medium bg-stone-100 text-stone-600 border border-stone-200";

                // 显示详情卡片
                document.getElementById('card-location').innerText = location.name;
                document.getElementById('card-role').innerText = location.role.split('·')[1] || location.role;
                document.getElementById('card-title').innerText = location.poem.title;
                document.getElementById('card-poem').innerText = location.poem.content;
                document.getElementById('card-desc').innerText = location.desc;

                infoPanel.classList.remove('opacity-0', 'translate-x-8');
            }
        }

        // ==========================================
        // 5. 动画引擎
        // ==========================================
        let isPlaying = false;
        let currentYear = -2737;
        const END_YEAR = 1900;
        const SPEED = 15; // 年/秒

        let lastTime = 0;
        let animId;

        function loop(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const delta = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            if (isPlaying) {
                currentYear += delta * SPEED;
                if (currentYear >= END_YEAR) {
                    currentYear = END_YEAR;
                    isPlaying = false;
                    updatePlayBtn();
                }
                renderByYear(currentYear);
                animId = requestAnimationFrame(loop);
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            updatePlayBtn();
            if (isPlaying) {
                lastTime = 0;
                animId = requestAnimationFrame(loop);
            } else {
                cancelAnimationFrame(animId);
            }
        }

        function updatePlayBtn() {
            const btn = document.getElementById('play-btn');
            const playIcon = document.getElementById('icon-play');
            const pauseIcon = document.getElementById('icon-pause');

            if (isPlaying) {
                btn.classList.add('play-btn-active', 'bg-emerald-800');
                btn.classList.remove('bg-stone-800');
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                btn.classList.remove('play-btn-active', 'bg-emerald-800');
                btn.classList.add('bg-stone-800');
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
        }

        function manualScrub() {
            isPlaying = false;
            updatePlayBtn();
            currentYear = parseFloat(document.getElementById('timeline').value);
            renderByYear(currentYear);
        }

        // 初始化
        window.onload = () => {
            renderByYear(-2737);
        };
    </script>
</body>
</html>
